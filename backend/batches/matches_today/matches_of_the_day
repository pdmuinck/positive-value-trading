#!/bin/bash

./delete_jobs value-bets &
./delete_jobs closing-lines
wait

filterSports=Soccer

# get sport radar
matches=$(./event_full_feed \
| grep "${filterSports}")

# get books
sbtech=$(./sbtech "${matches}")
pinnacle=$(./pinnacle "${matches}")
#bwin=$(./bwin "${matches}")
wait

create_jobs() {
  sport_radar_id=$(echo "${match}" | cut -d ',' -f 3)
  start_time=$(echo "${match}" | cut -d ',' -f 4 |tr -d ':' |tr -d '"')

  # to test locally replace date commands with gdate command
  value_bet_start_hour=$(date -d "$(date -Iseconds -d "${start_time}") - 3 hours" +%H)
  value_bet_start_minutes=$(date -d "$(date -Iseconds -d "${start_time}") - 3 hours" +%M)
  closing_line_start_hour=$(date -d "$(date -Iseconds -d "${start_time}") - 1 minute" +%H)
  closing_line_start_minutes=$(date -d "$(date -Iseconds -d "${start_time}") - 1 minute" +%M)
  value_bet_schedule=""${value_bet_start_minutes}" "${value_bet_start_hour}" * * *"
  closing_line_schedule=""${closing_line_start_minutes}" "${closing_line_start_hour}" * * *"

  sbtech_id=$(echo "${sbtech}" | grep "${sport_radar_id}" | cut -d ',' -f 1 | tr -d '"')
  pinnacle_id=$(echo "${pinnacle}" | grep "${sport_radar_id}" | cut -d ',' -f 1)
  #bwin_id=$(echo "${bwin}" | grep "${sport_radar_id}" | cut -d ',' -f 1 | tr -d '"')


  if [ -n "$pinnacle_id" ]; then
      value_bet_body="${sport_radar_id}","${start_time}","${pinnacle_id}","${sbtech_id}"
      closing_line_body="${pinnacle_id}","${sport_radar_id}"

      value_bet_service_uri="https://find-value-bets-sah63l2xba-ew.a.run.app"
      closing_line_service_uri="https://closing-lines-sah63l2xba-ew.a.run.app"
      ./create_job "find-value-bets" "${value_bet_schedule}" "${value_bet_service_uri}" "${value_bet_body}" "find-value-bets-${sport_radar_id}"
      ./create_job "find-closing-lines" "${closing_line_schedule}" "${closing_line_service_uri}" "${closing_line_body}" "find-closing-lines-${sport_radar_id}"
  fi
}

IFS=$'\n'
for match in $matches;do
 create_jobs &
done

wait



